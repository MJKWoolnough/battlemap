const[e,t,s,i,o,n,r,d,a,l,c,h,E,m,u,f,N,_,g,p]=await Promise.all(["/lib/bbcode.js","/lib/bbcode_tags.js","/lib/bind.js","/lib/css.js","/lib/dom.js","/lib/drag.js","/lib/html.js","/lib/inter.js","/lib/misc.js","/lib/nodes.js","/lib/svg.js","/folders.js","/ids.js","/language.js","/messaging.js","/plugins.js","/rpc.js","/shared.js","/symbols.js","/windows.js"].map(include)),R=m.makeLangPack({ERROR_FOLDER_NOT_EMPTY:"Cannot remove a non-empty folder",ERROR_INVALID_FOLDER:"Invalid Folder",ERROR_INVALID_ITEM:"Invalid Item",ERROR_INVALID_PATH:"Invalid Path",MENU_TITLE:"Notes",NAME_EXISTS:"Note Exists",NAME_EXISTS_LONG:"A note with that name already exists",NAME_INVALID:"Invalid Name",NAME_INVALID_LONG:"Note names cannot contains the '/' (slash) character",NOTE:"Note",NOTE_EDIT:"Edit Note",NOTE_POPOUT:"Open in New Window",NOTE_SAVE:"Save Note",NOTE_SHARE:"Allow Note Sharing",NOTES_NEW:"New Note",NOTES_NEW_LONG:"Enter new note name",SHARE:"Share"}),w=`data:image/svg+xml,%3Csvg xmlns="${c.ns}" viewBox="0 0 84 96" width="84" height="96" %3E%3Crect x="60" y="6" width="24" height="90" fill="%23888" rx="10" /%3E%3Crect x="1" y="6" width="80" height="90" stroke="%23000" fill="%23fff" rx="10" /%3E%3Cg id="h"%3E%3Ccircle cx="16" cy="11" r="2" fill="%23333" /%3E%3Cellipse cx="15" cy="6" rx="3" ry="5" stroke="%23aaa" stroke-width="2" fill="none" stroke-dasharray="0 5 15" /%3E%3C/g%3E%3Cuse href="%23h" x="10" /%3E%3Cuse href="%23h" x="20" /%3E%3Cuse href="%23h" x="30" /%3E%3Cuse href="%23h" x="40" /%3E%3Cuse href="%23h" x="50" /%3E%3Cpath d="M11,25 h60 M11,40 h60 M11,55 h60 M11,70 h30" stroke="%23000" stroke-width="4" stroke-linecap="round" /%3E%3C/svg%3E`;if(u.register("plugin-notes",[w,R.NOTE]),N.isAdmin){class t extends h.DraggableItem{static#e=new Set;#t=null;#s=null;#i=null;#o;#n=!1;constructor(e,t,s){super(e,t,s,A),o.amendNode(this.image,{src:w}),D.set(t,this),this.#o=u.bbcodeDrag.register((()=>e=>`[note=${t}]${e||this.name}[/note]`)),o.amendNode(this.nameElem,{onauxclick:e=>{1===e.button&&(this.#s?this.#s.focus():this.#r())}})}static checkEditors(){for(const e of t.#e)if(e.#n)return!0;return!1}#d(e){this.#n&&(e.preventDefault(),this.#t?.confirm(m.default.ARE_YOU_SURE,m.default.UNSAVED_CHANGES,w).then((e=>{e&&(this.#n=!1,this.#t?.remove())})))}#r(){(this.#n?this.#t?.confirm(m.default.ARE_YOU_SURE,m.default.UNSAVED_CHANGES,w)??Promise.resolve(!0):Promise.resolve(!0)).then((e=>{if(e){this.#n=!1;const e=window.open("","","");e&&((this.#s=e).addEventListener("unload",(()=>this.#s=null)),e.document.head.append(r.title(this.name),i.render(),r.link({rel:"shortcut icon",sizes:"any",href:w})),e.document.body.classList.add(z),e.document.body.append(u.parseBBCode(L.get(this.id)?.data.contents||"")),this.#t?.remove())}}))}show(){if(this.#t)this.#t.focus();else if(this.#s)this.#s.focus();else{const e=r.div({class:z},u.parseBBCode(L.get(this.id)?.data.contents||""));o.amendNode(p.shell,this.#t=p.windows({"window-title":this.name,"window-icon":w,"hide-minimise":!1,resizable:!0,style:"--window-width: 50%; --window-height: 50%",onclose:e=>this.#d(e),onremove:()=>{this.#t=null,this.#i=null,t.#e.delete(this)}},e)),this.#t.addControlButton(v,(()=>this.#r()),R.NOTE_POPOUT),this.#t.addControlButton(S,(()=>{if(t.#e.has(this))this.#n?this.#t?.confirm(m.default.ARE_YOU_SURE,m.default.UNSAVED_CHANGES,w).then((s=>{s&&(this.#n=!1,o.clearNode(this.#t,{"window-title":this.name,class:void 0},e),t.#e.delete(this))})):(o.clearNode(this.#t,{"window-title":this.name,class:void 0},e),t.#e.delete(this));else{t.#e.add(this);const i=L.get(this.id)||{user:!1,data:{contents:"",share:!1}},d=s.default(""),a=()=>d.value=(this.#n=l.value!==i.data.contents||c.checked!==i.data.share)?"*":"",l=r.textarea({ondragover:n.setDragEffect({link:[u.bbcodeDrag]}),oninput:a,ondrop:e=>{if(u.bbcodeDrag.is(e)){const{selectionStart:t,selectionEnd:s}=l,i=u.bbcodeDrag.get(e);i&&l.setRangeText(i(l.value.slice(Math.min(t,s),Math.max(t,s))))}}},i.data.contents),c=r.input({type:"checkbox",class:E.settingsTicker,checked:i.data.share,onchange:a});o.clearNode(this.#t,{"window-title":s.default`${R.NOTE_EDIT}${d}: ${this.name}`,class:q},[_.labels([R.NOTE,": "],l),r.br(),_.labels(c,[R.NOTE_SHARE,": "]),r.br(),r.button({onclick:()=>{i.data={contents:l.value,share:c.checked},L.set(this.id,i),N.rpc.pluginSetting(T,{[this.id+""]:i},[]),o.clearNode(e,u.parseBBCode(l.value)),a(),this.#a()}},R.NOTE_SAVE)])}}),R.NOTE_EDIT),this.#a()}}ondragstart(e){super.ondragstart(e),e.defaultPrevented||u.bbcodeDrag.set(e,this.#o)}delete(){this.#t?.remove(),this.#s?.close(),u.bbcodeDrag.deregister(this.#o)}#a(){L.has(this.id)&&L.get(this.id).data.share?this.#i??=this.#t.addControlButton(g.shareStr,(()=>{const e=L.get(this.id);e&&N.rpc.broadcastWindow("plugin-notes",this.id,e.data.contents)}),R.SHARE):(this.#i?.(),this.#i=null)}filter(e){const t=L.get(this.id)?.data.contents.toLowerCase()||"";return super.filter(e.every((e=>t.includes(e)))?[]:e)}}o.amendNode(window,{onbeforeunload:e=>{t.checkEditors()&&e.preventDefault()}});class I extends h.DragFolder{constructor(e,t,s,i){super(e,t,s,i,A,b)}removeItem(e){const t=super.removeItem(e);return D.delete(t),t}}let O=0;const A=new n.DragTransfer("pluginnote"),b=new n.DragTransfer("pluginnotefolder"),T=f.pluginName(import.meta),S=`data:image/svg+xml,%3Csvg xmlns="${c.ns}" viewBox="0 0 70 70" fill="none" stroke="%23000"%3E%3Cpolyline points="51,7 58,0 69,11 62,18 51,7 7,52 18,63 62,18" stroke-width="2" /%3E%3Cpath d="M7,52 L1,68 L18,63 M53,12 L14,51 M57,16 L18,55" /%3E%3C/svg%3E`,v=`data:image/svg+xml,%3Csvg xmlns="${c.ns}" viewBox="0 0 15 15"%3E%3Cpath d="M7,1 H1 V14 H14 V8 M9,1 h5 v5 m0,-5 l-6,6" stroke-linejoin="round" fill="none" stroke="currentColor" /%3E%3C/svg%3E`,L=new Map,D=new Map,P={user:!1,data:{folders:{},items:{}}},j=e=>{if(!(e instanceof Object&&e.folders instanceof Object&&e.items instanceof Object))return!1;for(const t in e.items)if(!a.isInt(e.items[t],0))return!1;for(const t in e.folders)if(!j(e.folders[t]))return!1;return!0},M=e=>e instanceof Object&&"string"==typeof e.contents,V=e=>{if(!(e instanceof Object&&e[""]instanceof Object&&!1===e[""].user&&j(e[""].data)))return P;for(const t in e)if(""!==t){const s=parseInt(t);!isNaN(s)&&e[t]instanceof Object&&!e[t].user&&M(e[t].data)&&(L.set(s,e[t]),s>O&&(O=s))}return e[""]},C=d.Subscription.bind(1),x=d.Subscription.bind(1),k=d.Subscription.bind(1),y=d.Subscription.bind(1),H=d.Subscription.bind(1),W=d.Subscription.bind(1),G=new d.Subscription((()=>{})),F=V(f.getSettings(T)),B=(e,t=F.data)=>{const s=e.split("/"),i=s.pop()??"";for(const e of s)if(e&&!(t=t.folders[e]))return[null,i];return[t,i]},U=e=>{const t=e.split("/");e="";for(const s of t)s&&(e+=`/${s}`);return e},$=new h.Root(F.data,R.MENU_TITLE,{list:()=>Promise.resolve(F.data),createFolder:e=>{const[t,s]=B(e);return t?t.folders[s]?(N.handleError(R.NAME_EXISTS_LONG),Promise.reject(R.NAME_EXISTS_LONG)):(t.folders[s]={folders:{},items:{}},N.rpc.pluginSetting(T,{"":F},[]),Promise.resolve(e)):(N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH))},move:(e,t)=>{const[s,i]=B(e),[o,n]=B(t);if(!s||!o)return N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH);const r=s.items[i];return void 0===r?(N.handleError(R.ERROR_INVALID_ITEM),Promise.reject(R.ERROR_INVALID_ITEM)):o.items[n]?(N.handleError(R.NAME_EXISTS_LONG),Promise.reject(R.NAME_EXISTS_LONG)):(delete s.items[i],o.items[n]=r,N.rpc.pluginSetting(T,{"":F},[]),Promise.resolve(t))},moveFolder:(e,t)=>{if(e=U(e),(t=U(t)).startsWith(e))return N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH);const[s,i]=B(e),[o,n]=B(t);return s&&o?s.folders[i]?o.folders[n]?(N.handleError(R.NAME_EXISTS_LONG),Promise.reject(R.NAME_EXISTS_LONG)):(o.folders[n]=s.folders[i],delete s.folders[i],N.rpc.pluginSetting(T,{"":F},[]),Promise.resolve(t)):(N.handleError(R.ERROR_INVALID_FOLDER),Promise.reject(R.ERROR_INVALID_FOLDER)):(N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH))},remove:e=>{const[t,s]=B(e);if(!t)return N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH);const i=t.items[s];return void 0===i?(N.handleError(R.ERROR_INVALID_ITEM),Promise.reject(R.ERROR_INVALID_ITEM)):(L.delete(i),delete t.items[s],N.rpc.pluginSetting(T,{"":F},[i+""]),Promise.resolve())},removeFolder:e=>{const[t,s]=B(U(e));if(!t)return N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH);const i=t.folders[s];return i?0!==Object.keys(i.folders).length||0!==Object.keys(i.items).length?(N.handleError(R.ERROR_FOLDER_NOT_EMPTY),Promise.reject(R.ERROR_FOLDER_NOT_EMPTY)):(delete t.folders[s],N.rpc.pluginSetting(T,{"":F},[]),Promise.resolve()):(N.handleError(R.ERROR_INVALID_FOLDER),Promise.reject(R.ERROR_INVALID_FOLDER))},copy:(e,t)=>{const[s,i]=B(t);if(!s)return N.handleError(R.ERROR_INVALID_PATH),Promise.reject(R.ERROR_INVALID_PATH);if(s.items[i])return N.handleError(R.NAME_EXISTS_LONG),Promise.reject(R.NAME_EXISTS_LONG);const o=++O,n=_.cloneObject(L.get(e));return s.items[i]=o,L.set(o,n),N.rpc.pluginSetting(T,{"":F,[o+""]:n},[]),Promise.resolve({id:o,path:t})},waitAdded:()=>C[0],waitMoved:()=>x[0],waitRemoved:()=>k[0],waitCopied:()=>G,waitFolderAdded:()=>y[0],waitFolderMoved:()=>H[0],waitFolderRemoved:()=>W[0]},t,I),X=(e,t,s,i)=>{for(const o in e.folders){const n=s+o+"/";t.folders[o]?X(e.folders[o],t.folders[o],n,i):i[n]=-1}for(const o in t.folders)e.folders[o]||(i[s+o+"/"]=0);for(const o in e.items)t.items[o]?e.items[o]!==t.items[o]&&(i[""]=1):i[s+o]=-e.items[o];for(const o in t.items)e.items[o]?e.items[o]!==t.items[o]&&(i[""]=1):i[s+o]=t.items[o]},Y=i.id(),z=i.id(),q=i.id();i.add({[`#${Y}`]:{" ul":{"padding-left":"1em","list-style":"none"},">div>ul":{padding:0}},[`.${q} textarea`]:{width:"calc(100% - 10em)",height:"calc(100% - 5em)"},[`.${z}`]:{"user-select":"text","white-space":"pre-wrap","font-family":"'Andale Mono',monospace"}}),$.windowIcon=w,f.addPlugin("notes",{menuItem:{fn:[R.MENU_TITLE,r.div({id:Y},[r.button({onclick:()=>p.shell.prompt(R.NOTES_NEW,[R.NOTES_NEW_LONG,": "],"").then((e=>{if(e)if(e.includes("/"))p.shell.alert(R.NAME_INVALID,R.NAME_INVALID_LONG);else if($.getItem(`/${e}`))p.shell.alert(R.NAME_EXISTS,R.NAME_EXISTS_LONG);else{const t={user:!1,data:{contents:"",share:!1}};$.addItem(++O,e),L.set(F.data.items[e]=O,t),N.rpc.pluginSetting(T,{"":F,[O]:t},[])}}))},R.NOTES_NEW),$[l.node]]),!0,w]}}),N.rpc.waitPluginSetting().when((({id:e,setting:t,removing:s})=>{if(e===T){for(const e of s){const t=parseInt(e);isNaN(t)||L.delete(t)}for(const e in t)if(""===e){if(!j(t[""].data))continue;const e={};X(F.data,t[""].data,"/",e);const s=Object.keys(e);let i=!1;if(e[""]||s.length>2)i=!0;else if(1===s.length)e[s[0]]<0?s[0].endsWith("/")?W[1](s[0]):k[1](s[0]):s[0].endsWith("/")?y[1](s[0]):C[1]([{id:e[s[0]],name:s[0]}]);else if(2===s.length)if(s[0].endsWith("/")===s[1].endsWith("/"))if(s[0].endsWith("/")){const o={};e[s[0]]<0?X(B(s[0])[0],B(s[1],t[""].data)[0],"/",o):X(B(s[0],t[""].data)[0],B(s[1])[0],"/",o),0===Object.keys(o).length?H[1](e[s[0]]<0?{from:s[0],to:s[1]}:{from:s[1],to:s[0]}):i=!0}else e[s[0]]+e[s[1]]===0?x[1](e[s[0]]<0?{from:s[0],to:s[1]}:{from:s[1],to:s[0]}):i=!0;else i=!0;i&&$.setRoot(t[""].data),F.data=t[""].data}else{const s=parseInt(e),i=t[e];!isNaN(s)&&M(i.data)&&L.set(s,i)}}})),u.registerTag("note",((t,s,i)=>{const n=s.next(!0).value;if(n&&e.isOpenTag(n)&&n.attr){const d=parseInt(n.attr);isNaN(d)||o.amendNode(t,e.process(r.span({class:E.psuedoLink,onclick:()=>D.get(d)?.show()}),s,i,n.tagName))}}))}else u.registerTag("note",t.none);