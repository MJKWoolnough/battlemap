#!/bin/bash

bm="$(dirname "$0")";
data="$bm/internal/static/";

(
	cd "$data";
	head -n4 index.html | tr -d '\n	';
	echo -n "<script type=\"module\">";
	jslib -i "$(grep "<script" index.html | grep -v "lib/load.js" | sed -e 's/.*src="\([^"]*\)".*/\1/')" | uglifyjs -cm | tr -d '\n'; # --mangle-props <- TODO:test this
	echo -n "</script><style type=\"text/css\">";
	grep -hv "^@import" *.css | uglifycss | tr -d '\n';
	echo -n "</style>";
	tail -n6 index.html | tr -d '\n	';
) | httpdir -p "battlemap" -g -f -s -i - -d "$(stat -c %Y "$(ls -t "$data"/*.js "$data"/*.html | head -n1)")" -o "$bm/index.go" -w "index.html";
