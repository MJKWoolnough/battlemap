#!/bin/bash

bm="$(dirname "$0")";
data="$bm/internal/static/";
jslibHTML="$(realpath "$bm/../jslib/html.sh")";
jslibSVG="$(realpath "$bm/../jslib/svg.sh")";
jslibJS="$(realpath "$bm/../jslib/lib.js/")";

(
	cd "$data";
	cp -f "$jslibJS/"*.js "lib/";
	head -n4 index.html | tr -d '\n	';
	echo -n "<script type=\"module\">";
	jslib -i "$(grep "<script" index.html | grep -v "lib/load.js" | sed -e 's/.*src="\([^"]*\)".*/\1/')" | $jslibHTML "lib/" | $jslibSVG "lib/" | terser -cm | tr -d '\n'; # --mangle-props <- TODO:test this
	echo -n "</script><style type=\"text/css\">";
	grep -hv "^@import" *.css | uglifycss | tr -d '\n';
	echo -n "</style>";
	tail -n5 index.html | tr -d '\n	';
) | httpdir -p "battlemap" -g -z -f -s -i - -d "$(stat -c %Y "$(ls -t "$data"/*.js "$data"/*.html | head -n1)")" -o "$bm/index.go" -w "index.html";
httpdir -p "battlemap" -g -z -f -s -d "$(stat -c %Y "$data"/favicon.ico)" -i "$data"/favicon.ico -o "$bm/favicon.go" -w "favicon.ico";
